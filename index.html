<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ScandiKitchen v3.0</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="recipes.js"></script>
    <style>
        :root {
            --bg: #f4f1ea; --olive: #556b2f; --light: #d4e0c0; --white: #ffffff; --text: #2c3e50;
        }
        body {
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background: var(--bg); color: var(--text); margin: 0; padding-bottom: 80px;
        }
        .container { max-width: 800px; margin: 0 auto; padding: 20px; }
        
        /* UI Components */
        .card { 
            background: var(--white); border-radius: 20px; padding: 20px; 
            box-shadow: 0 8px 24px rgba(0,0,0,0.05); margin-bottom: 20px;
            transition: transform 0.2s;
        }
        .card:active { transform: scale(0.99); }
        .btn {
            background: var(--olive); color: white; border: none; padding: 12px 20px;
            border-radius: 12px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 8px;
        }
        .btn-sm { padding: 6px 12px; font-size: 14px; }
        .input-num { width: 60px; padding: 5px; border: 1px solid var(--light); border-radius: 8px; }

        /* Navigation */
        .nav-tabs { display: flex; overflow-x: auto; gap: 10px; margin-bottom: 20px; padding-bottom: 10px; }
        .tab { 
            white-space: nowrap; padding: 10px 18px; background: var(--white); 
            border-radius: 15px; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .tab.active { background: var(--olive); color: white; }

        /* Recipe Page */
        .instr-step { cursor: pointer; padding: 8px; border-radius: 10px; transition: 0.3s; white-space: pre-line; }
        .instr-step.done { opacity: 0.4; text-decoration: line-through; }
        .timer-link { color: var(--olive); font-weight: bold; text-decoration: underline; cursor: pointer; }
        
        .photo-uploader {
            width: 100%; height: 200px; background: #eee; border-radius: 20px;
            display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative;
        }
        .photo-uploader img { width: 100%; height: 100%; object-fit: cover; }

        /* Floating Timer Widget */
        .timer-widget {
            position: fixed; top: 20px; right: 20px; background: var(--olive); color: white;
            padding: 15px 25px; border-radius: 30px; box-shadow: 0 10px 20px rgba(0,0,0,0.2);
            z-index: 1000; display: flex; align-items: center; gap: 15px;
        }

        /* Bottom Menu */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0; background: var(--white);
            display: flex; justify-content: space-around; padding: 15px; box-shadow: 0 -5px 15px rgba(0,0,0,0.05);
        }

        [v-cloak] { display: none; }
    </style>
</head>
<body>
    <div id="app" v-cloak>
        <div v-if="timeLeft > 0" class="timer-widget">
            <span>‚è± {{ Math.floor(timeLeft / 60) }}:{{ (timeLeft % 60).toString().padStart(2, '0') }}</span>
            <button @click="timeLeft = 0" style="background:none; border:none; color:white; font-size:20px; cursor:pointer">‚úï</button>
        </div>

        <div class="container">
            <div v-if="view === 'catalog'">
                <h1>ScandiKitchen</h1>
                <input type="text" v-model="search" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∏–ª–∏ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—É..." class="card" style="width:100%; box-sizing:border-box; border:none;">
                
                <div class="nav-tabs">
                    <div class="tab" :class="{active: filterCat === ''}" @click="filterCat = ''">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</div>
                    <div v-for="cat in mainCategories" :key="cat" class="tab" :class="{active: filterCat === cat}" @click="filterCat = cat">{{cat}}</div>
                </div>

                <div v-for="recipe in filteredRecipes" :key="recipe.id" class="card" @click="openRecipe(recipe)">
                    <div style="font-size: 40px">{{recipe.emoji}}</div>
                    <h3>{{recipe.title}}</h3>
                    <p style="opacity: 0.6">{{recipe.mainCategory}} ‚Ä¢ {{recipe.time}} –º–∏–Ω</p>
                </div>
            </div>

            <div v-if="view === 'recipe'">
                <button @click="view = 'catalog'" class="btn btn-sm btn-outline">‚Üê –ù–∞–∑–∞–¥</button>
                
                <div class="photo-uploader" @click="$refs.file.click()">
                    <img v-if="userPhotos[currentRecipe.id]" :src="userPhotos[currentRecipe.id]">
                    <span v-else>üì∑ –ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ</span>
                    <input type="file" ref="file" @change="uploadPhoto" style="display:none">
                </div>

                <h2>{{currentRecipe.emoji}} {{currentRecipe.title}}</h2>

                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h4>–ü–æ—Ä—Ü–∏–∏: {{servings}}</h4>
                        <div style="display:flex; gap:10px;">
                            <button @click="servings--" class="btn btn-sm">-</button>
                            <button @click="servings++" class="btn btn-sm">+</button>
                        </div>
                    </div>
                    
                    <div v-for="(ing, idx) in currentRecipe.ingredients" :key="idx" style="margin: 10px 0; display:flex; justify-content:space-between; align-items:center;">
                        <span :style="{textDecoration: stockCheck[ing.name] ? 'line-through' : 'none'}">
                            {{ing.name}}: <b>{{ (ing.amount / 2 * servings).toFixed(1) }} {{ing.unit}}</b>
                        </span>
                        <div style="display:flex; gap:8px; align-items:center;">
                            <input type="number" v-model.number="stock[ing.name]" placeholder="0" class="input-num">
                            <input type="checkbox" v-model="stockCheck[ing.name]">
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h4>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è (–Ω–∞–∂–º–∏—Ç–µ –Ω–∞ —à–∞–≥, —á—Ç–æ–±—ã –≤—ã—á–µ—Ä–∫–Ω—É—Ç—å)</h4>
                    <div v-for="(line, idx) in formattedSteps" :key="idx" 
                         class="instr-step" :class="{done: doneSteps.includes(idx)}"
                         @click="toggleStep(idx)" v-html="line">
                    </div>
                </div>

                <div style="display:flex; gap:10px;">
                    <button class="btn" @click="addToPlan">üìÖ –í –ø–ª–∞–Ω –Ω–µ–¥–µ–ª–∏</button>
                    <a v-if="currentRecipe.videoUrl" :href="currentRecipe.videoUrl" target="_blank" class="btn" style="background:#0088cc">Telegram –í–∏–¥–µ–æ</a>
                </div>
            </div>

            <div v-if="view === 'shopping'">
                <h1>–°–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫</h1>
                <div class="card">
                    <div v-for="(items, cat) in aggregatedShoppingList" :key="cat">
                        <h4 style="color:var(--olive); border-bottom:1px solid var(--light)">{{cat}}</h4>
                        <div v-for="item in items" :key="item.name" style="padding:5px 0; display:flex; justify-content:space-between;">
                            <span>{{item.name}}</span>
                            <b>{{item.buy}} {{item.unit}}</b>
                        </div>
                    </div>
                    <div v-if="Object.keys(aggregatedShoppingList).length === 0" style="padding:20px; text-align:center; opacity:0.5;">
                        –í–∞—à —Å–ø–∏—Å–æ–∫ –ø—É—Å—Ç. –î–æ–±–∞–≤—å—Ç–µ –±–ª—é–¥–∞ –≤ –ø–ª–∞–Ω!
                    </div>
                </div>
                <button @click="exportTelegram" class="btn" style="width:100%; justify-content:center; background:#24A1DE">
                    ‚úà –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ Telegram
                </button>
            </div>
        </div>

        <nav class="bottom-nav">
            <div @click="view = 'catalog'">üìñ –ö–Ω–∏–≥–∏</div>
            <div @click="view = 'shopping'">üõí –ü–æ–∫—É–ø–∫–∏</div>
        </nav>
    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    view: 'catalog',
                    search: '',
                    filterCat: '',
                    currentRecipe: null,
                    servings: 2,
                    timeLeft: 0,
                    timerInt: null,
                    doneSteps: [],
                    // Persistence
                    plan: JSON.parse(localStorage.getItem('sk_plan') || '[]'),
                    stock: JSON.parse(localStorage.getItem('sk_stock') || '{}'),
                    stockCheck: JSON.parse(localStorage.getItem('sk_checks') || '{}'),
                    userPhotos: JSON.parse(localStorage.getItem('sk_photos') || '{}'),
                    mainCategories: ['üçú –°—É–ø—ã', 'ü•ó –°–∞–ª–∞—Ç—ã', 'ü•© –û—Å–Ω–æ–≤–Ω—ã–µ (–º—è—Å–æ, –ø—Ç–∏—Ü–∞)', 'üêü –û—Å–Ω–æ–≤–Ω—ã–µ (—Ä—ã–±–∞, –º–æ—Ä–µ–ø—Ä–æ–¥—É–∫—Ç—ã)', 'ü•ß –í—ã–ø–µ—á–∫–∞', 'üç∞ –î–µ—Å–µ—Ä—Ç—ã', 'üçπ –ù–∞–ø–∏—Ç–∫–∏']
                }
            },
            computed: {
                filteredRecipes() {
                    return initialRecipes.filter(r => {
                        const matchSearch = r.title.toLowerCase().includes(this.search.toLowerCase()) || 
                                            r.ingredients.some(i => i.name.toLowerCase().includes(this.search.toLowerCase()));
                        const matchCat = this.filterCat === '' || r.mainCategory === this.filterCat;
                        return matchSearch && matchCat;
                    });
                },
                formattedSteps() {
                    if(!this.currentRecipe) return [];
                    return this.currentRecipe.instructions.split('\n').map(step => {
                        return step.replace(/(\d+)\s*(–º–∏–Ω—É—Ç|–º–∏–Ω)/gi, (match, p1) => {
                            return `<span class="timer-link" onclick="window.app.startTimer(${p1})">${match}</span>`;
                        });
                    });
                },
                aggregatedShoppingList() {
                    let total = {};
                    this.plan.forEach(recipe => {
                        recipe.ingredients.forEach(ing => {
                            if(!total[ing.name]) total[ing.name] = { ...ing, amount: 0 };
                            // –£—á–∏—Ç—ã–≤–∞–µ–º –ø–æ—Ä—Ü–∏–∏ (–±–∞–∑–æ–≤–∞—è –±–∞–∑–∞ –Ω–∞ 2 –ø–æ—Ä—Ü–∏–∏)
                            total[ing.name].amount += (ing.amount / 2 * (recipe.servings || 2));
                        });
                    });

                    let grouped = {};
                    for(let name in total) {
                        const needed = total[name].amount;
                        const has = this.stock[name] || 0;
                        const buy = needed - has;

                        if(buy > 0 && !this.stockCheck[name]) {
                            const cat = total[name].category || '–ü—Ä–æ—á–µ–µ';
                            if(!grouped[cat]) grouped[cat] = [];
                            grouped[cat].push({ name, buy: buy.toFixed(1), unit: total[name].unit });
                        }
                    }
                    return grouped;
                }
            },
            methods: {
                openRecipe(r) {
                    this.currentRecipe = r;
                    this.view = 'recipe';
                    this.servings = 2;
                    this.doneSteps = [];
                },
                toggleStep(idx) {
                    if(this.doneSteps.includes(idx)) this.doneSteps = this.doneSteps.filter(i => i !== idx);
                    else this.doneSteps.push(idx);
                },
                startTimer(mins) {
                    this.timeLeft = mins * 60;
                    if(this.timerInt) clearInterval(this.timerInt);
                    this.timerInt = setInterval(() => {
                        if(this.timeLeft > 0) this.timeLeft--;
                        else clearInterval(this.timerInt);
                    }, 1000);
                },
                uploadPhoto(e) {
                    const file = e.target.files[0];
                    const reader = new FileReader();
                    reader.onload = (f) => {
                        this.userPhotos[this.currentRecipe.id] = f.target.result;
                        localStorage.setItem('sk_photos', JSON.stringify(this.userPhotos));
                    };
                    reader.readAsDataURL(file);
                },
                addToPlan() {
                    this.plan.push({...this.currentRecipe, servings: this.servings});
                    localStorage.setItem('sk_plan', JSON.stringify(this.plan));
                    alert("–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –ø–ª–∞–Ω!");
                },
                exportTelegram() {
                    let msg = "üõí –ú–û–ô –°–ü–ò–°–û–ö –ü–û–ö–£–ü–û–ö:\n\n";
                    for(let cat in this.aggregatedShoppingList) {
                        msg += `--- ${cat.toUpperCase()} ---\n`;
                        this.aggregatedShoppingList[cat].forEach(i => {
                            msg += `‚Ä¢ ${i.name}: ${i.buy} ${i.unit}\n`;
                        });
                        msg += "\n";
                    }
                    window.location.href = `tg://msg?text=${encodeURIComponent(msg)}`;
                }
            },
            watch: {
                stock: { deep: true, handler(v) { localStorage.setItem('sk_stock', JSON.stringify(v)) }},
                stockCheck: { deep: true, handler(v) { localStorage.setItem('sk_checks', JSON.stringify(v)) }}
            },
            mounted() {
                window.app = this;
            }
        }).mount('#app');
    </script>
</body>
</html>
