<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ScandiKitchen Pro</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --milk: #f4f1ea;
            --olive: #556b2f;
            --text: #333333;
            --white: #ffffff;
            --shadow: 0 10px 30px rgba(0,0,0,0.05);
            --radius: 20px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            font-family: 'Helvetica Neue', 'Inter', sans-serif; 
            background-color: var(--milk); 
            color: var(--text); 
            margin: 0; padding-bottom: 80px;
        }

        /* –ù–∞–≤–∏–≥–∞—Ü–∏—è */
        nav {
            background: var(--white);
            padding: 15px 20px;
            display: flex; justify-content: space-between; align-items: center;
            position: sticky; top: 0; z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.02);
        }

        .logo { font-weight: 600; font-size: 1.2rem; color: var(--olive); cursor: pointer; }

        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä */
        .container { max-width: 1000px; margin: 0 auto; padding: 20px; }

        /* –ö–∞—Ä—Ç–æ—á–∫–∏ –∏ –ö–Ω–æ–ø–∫–∏ */
        .card {
            background: var(--white); border-radius: var(--radius);
            padding: 20px; margin-bottom: 20px; box-shadow: var(--shadow);
            transition: transform 0.2s;
        }
        .card:active { transform: scale(0.98); }

        .btn {
            border: none; border-radius: 15px; padding: 12px 20px;
            font-size: 1rem; cursor: pointer; font-weight: 600;
            transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px;
        }
        .btn-main { background: var(--olive); color: white; }
        .btn-day { width: 50px; height: 50px; border-radius: 15px; background: #eee; }

        /* –ü–æ–∏—Å–∫ –∏ —Ñ–∏–ª—å—Ç—Ä—ã */
        .search-box {
            width: 100%; padding: 15px; border-radius: 15px;
            border: 1px solid #ddd; margin-bottom: 15px; font-size: 1rem;
        }

        /* –ö–ë–ñ–£ */
        .kbju-badge {
            display: flex; gap: 10px; font-size: 0.8rem; margin-top: 10px; opacity: 0.7;
        }

        /* –¢–∞–π–º–µ—Ä */
        .smart-timer-btn {
            background: #e8eedc; color: var(--olive); padding: 2px 8px;
            border-radius: 5px; cursor: pointer; font-weight: 600; border-bottom: 2px solid var(--olive);
        }
        .floating-timer {
            position: fixed; bottom: 90px; right: 20px;
            background: var(--olive); color: white; padding: 15px 25px;
            border-radius: 50px; z-index: 1000; box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        }

        /* –®–∞–≥–∏ –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è */
        .step-item { padding: 12px; border-radius: 10px; cursor: pointer; white-space: pre-line; margin-bottom: 8px; border-left: 4px solid transparent; }
        .step-done { opacity: 0.4; text-decoration: line-through; border-left-color: var(--olive); background: #f9f9f9; }

        /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ */
        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.4); display: flex; align-items: center; justify-content: center; z-index: 200;
        }
        .modal { background: white; padding: 30px; border-radius: 25px; width: 90%; max-width: 400px; }

        /* –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –≤ –ø–æ–∫—É–ø–∫–∞—Ö */
        .dept-title { font-weight: 600; color: var(--olive); margin-top: 20px; border-bottom: 1px solid #eee; padding-bottom: 5px; }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è —Å–µ—Ç–∫–∞ */
        @media (min-width: 768px) {
            .recipe-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
        }
    </style>
</head>
<body>

<div id="app">
    <nav>
        <div class="logo" @click="view = 'home'">üåø ScandiKitchen</div>
        <div style="display:flex; gap:10px;">
            <button class="btn btn-main" @click="view = 'planner'">üìÖ –ü–ª–∞–Ω</button>
            <button class="btn" @click="view = 'shopping'" style="background:#e0ddd5">üõí –°–ø–∏—Å–æ–∫</button>
        </div>
    </nav>

    <div class="container">
        <div v-if="view === 'home'">
            <input type="text" v-model="search" placeholder="–ü–æ–∏—Å–∫ –ø–æ —Ä–µ—Ü–µ–ø—Ç—É –∏–ª–∏ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—É..." class="search-box">
            
            <div style="display:flex; gap:10px; overflow-x:auto; padding-bottom:15px; margin-bottom:10px;">
                <button v-for="cat in categories" @click="selCat = cat" 
                    :class="['btn', selCat === cat ? 'btn-main' : '']" style="white-space:nowrap">
                    {{cat}}
                </button>
            </div>

            <div class="recipe-grid">
                <div v-for="r in filteredRecipes" :key="r.id" class="card" @click="openRecipe(r)">
                    <div style="height:150px; background:#ddd; border-radius:15px; margin-bottom:10px;">
                        <img v-if="userPhotos[r.id]" :src="userPhotos[r.id]" style="width:100%; height:100%; object-fit:cover; border-radius:15px;">
                    </div>
                    <h3 style="margin:0">{{r.title}}</h3>
                    <div class="kbju-badge">
                        <span>üî• {{r.kcal}} –∫–∫–∞–ª</span>
                        <span>ü•© {{r.prot}}–≥ –ë</span>
                        <span>ü•ë {{r.fat}}–≥ –ñ</span>
                        <span>üçû {{r.carb}}–≥ –£</span>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="view === 'recipe'">
            <button class="btn" @click="view = 'home'">‚Üê –ù–∞–∑–∞–¥</button>
            <h1 style="margin:20px 0 10px 0;">{{curR.title}}</h1>
            
            <div class="card">
                <div style="display:flex; align-items:center; gap:20px; margin-bottom:20px;">
                    <span>–ü–æ—Ä—Ü–∏–π: <b>{{servings}}</b></span>
                    <button class="btn" @click="servings > 1 ? servings-- : 1" style="padding:5px 15px">-</button>
                    <button class="btn" @click="servings++" style="padding:5px 15px">+</button>
                </div>

                <h3>–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã / –ï—Å—Ç—å –¥–æ–º–∞</h3>
                <div v-for="ing in curR.ingredients" style="display:flex; justify-content:space-between; margin-bottom:10px;">
                    <span>{{ing.name}} ({{calcAmt(ing.amount)}} {{ing.unit}})</span>
                    <input type="number" v-model.number="stock[ing.name]" placeholder="–ï—Å—Ç—å –≥/—à—Ç" 
                        style="width:70px; border-radius:8px; border:1px solid #ddd; padding:4px;">
                </div>
                <button class="btn btn-main" style="width:100%; margin-top:20px;" @click="showDayPicker = true">üìÖ –î–æ–±–∞–≤–∏—Ç—å –≤ –ø–ª–∞–Ω</button>
            </div>

            <div class="card">
                <h3>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è</h3>
                <div v-for="(step, i) in curR.steps" :key="i" 
                    :class="['step-item', isDone(curR.id, i) ? 'step-done' : '']"
                    @click="toggleStep(curR.id, i)">
                    <span v-html="parseTimer(step)"></span>
                </div>
            </div>
        </div>

        <div v-if="view === 'planner'">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h2>–ü–ª–∞–Ω –Ω–∞ –Ω–µ–¥–µ–ª—é</h2>
                <button @click="clearPlan" style="color:red; background:none; border:none; cursor:pointer;">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë</button>
            </div>
            
            <div v-for="(list, day) in plan" :key="day" class="card">
                <h3 style="margin:0 0 10px 0; color:var(--olive)">{{day}}</h3>
                <div v-for="(item, idx) in list" style="display:flex; justify-content:space-between; margin-bottom:5px;">
                    <span>{{item.title}} ({{item.servs}} –ø–æ—Ä—Ü.)</span>
                    <span @click="removeFromPlan(day, idx)" style="color:red; cursor:pointer; font-weight:bold;">√ó</span>
                </div>
            </div>

            <div class="card" style="background:var(--olive); color:white;">
                <h3>–®–∞–±–ª–æ–Ω—ã</h3>
                <input type="text" v-model="tplName" placeholder="–ò–º—è —à–∞–±–ª–æ–Ω–∞" style="width:100%; padding:10px; border-radius:10px; margin-bottom:10px;">
                <button class="btn" style="background:white; color:var(--olive); width:100%;" @click="saveTpl">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–µ–∫—É—â–∏–π –ø–ª–∞–Ω</button>
                <div v-for="(data, name) in templates" :key="name" style="margin-top:10px; display:flex; justify-content:space-between;">
                    <span @click="loadTpl(name)" style="cursor:pointer; text-decoration:underline;">{{name}}</span>
                    <span @click="delTpl(name)" style="cursor:pointer; opacity:0.6;">—É–¥–∞–ª–∏—Ç—å</span>
                </div>
            </div>
        </div>

        <div v-if="view === 'shopping'">
            <h2>–°–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫</h2>
            <div v-for="(items, dept) in shoppingList" :key="dept">
                <div class="dept-title">{{dept}}</div>
                <div v-for="item in items" style="padding:10px 0; display:flex; justify-content:space-between;">
                    <label style="display:flex; gap:10px; align-items:center;">
                        <input type="checkbox"> <span>{{item.name}}</span>
                    </label>
                    <b>{{item.amount}} {{item.unit}}</b>
                </div>
            </div>
            <button class="btn btn-main" style="width:100%; margin-top:30px; background:#24A1DE;" @click="exportTG">‚úàÔ∏è –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ Telegram</button>
        </div>
    </div>

    <div class="overlay" v-if="showDayPicker" @click.self="showDayPicker = false">
        <div class="modal">
            <h3>–í –∫–∞–∫–æ–π –¥–µ–Ω—å –≥–æ—Ç–æ–≤–∏–º?</h3>
            <div style="display:grid; grid-template-columns: repeat(4, 1fr); gap:10px;">
                <button v-for="d in days" @click="addToPlan(d)" class="btn btn-day">{{d}}</button>
            </div>
        </div>
    </div>

    <div class="floating-timer" v-if="timeLeft > 0">
        ‚è± {{ Math.floor(timeLeft / 60) }}:{{ (timeLeft % 60).toString().padStart(2, '0') }}
    </div>
</div>

<script src="recipes.js"></script>
<script>
const { createApp } = Vue;

createApp({
    data() {
        return {
            view: 'home', search: '', selCat: 'üçú –°—É–ø—ã',
            categories: ['üçú –°—É–ø—ã','ü•ó –°–∞–ª–∞—Ç—ã','ü•© –û—Å–Ω–æ–≤–Ω—ã–µ (–º—è—Å–æ)','üêü –û—Å–Ω–æ–≤–Ω—ã–µ (—Ä—ã–±–∞)','üçö –ì–∞—Ä–Ω–∏—Ä—ã','ü•ß –í—ã–ø–µ—á–∫–∞','üç∞ –î–µ—Å–µ—Ä—Ç—ã','üçπ –ù–∞–ø–∏—Ç–∫–∏','ü•® –ó–∞–∫—É—Å–∫–∏','üßÇ –°–æ—É—Å—ã'],
            days: ['–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±','–í—Å'],
            recipes: myRecipes,
            curR: null, servings: 1, showDayPicker: false,
            stock: JSON.parse(localStorage.getItem('sk_stock') || '{}'),
            plan: JSON.parse(localStorage.getItem('sk_plan') || '{"–ü–Ω":[],"–í—Ç":[],"–°—Ä":[],"–ß—Ç":[],"–ü—Ç":[],"–°–±":[],"–í—Å":[]}'),
            doneSteps: JSON.parse(localStorage.getItem('sk_steps') || '{}'),
            userPhotos: JSON.parse(localStorage.getItem('sk_photos') || '{}'),
            templates: JSON.parse(localStorage.getItem('sk_tpls') || '{}'),
            tplName: '', timeLeft: 0, timerObj: null
        }
    },
    computed: {
        filteredRecipes() {
            return this.recipes.filter(r => {
                const matchSearch = r.title.toLowerCase().includes(this.search.toLowerCase()) || 
                                    r.ingredients.some(i => i.name.toLowerCase().includes(this.search.toLowerCase()));
                return matchSearch && r.category === this.selCat;
            });
        },
        shoppingList() {
            let needed = {};
            // –ê–≥—Ä–µ–≥–∞—Ü–∏—è –ø–æ –≤—Å–µ–º—É –ø–ª–∞–Ω—É
            Object.values(this.plan).flat().forEach(p => {
                const r = this.recipes.find(x => x.title === p.title);
                if (!r) return;
                r.ingredients.forEach(ing => {
                    if (!needed[ing.name]) needed[ing.name] = { amount: 0, unit: ing.unit, dept: ing.dept };
                    needed[ing.name].amount += (ing.amount / r.servings) * p.servs;
                });
            });

            // –í—ã—á–∏—Ç–∞–Ω–∏–µ –æ—Å—Ç–∞—Ç–∫–æ–≤ (–ò–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è)
            let final = {};
            for (let name in needed) {
                let have = this.stock[name] || 0;
                let buy = Math.max(0, needed[name].amount - have);
                if (buy > 0) {
                    let d = needed[name].dept || '–ü—Ä–æ—á–µ–µ';
                    if (!final[d]) final[d] = [];
                    final[d].push({ name, amount: buy.toFixed(1).replace('.0',''), unit: needed[name].unit });
                }
            }
            return final;
        }
    },
    methods: {
        openRecipe(r) { this.curR = r; this.servings = r.servings; this.view = 'recipe'; window.scrollTo(0,0); },
        calcAmt(amt) { return ((amt / this.curR.servings) * this.servings).toFixed(1).replace('.0',''); },
        parseTimer(text) {
            return text.replace(/(\d+)\s*(–º–∏–Ω—É—Ç|–º–∏–Ω)/g, (m, val) => `<span class="smart-timer-btn" onclick="startGlobalTimer(${val})">${m}</span>`);
        },
        toggleStep(rid, idx) {
            if (!this.doneSteps[rid]) this.doneSteps[rid] = [];
            let arr = this.doneSteps[rid];
            arr.includes(idx) ? arr.splice(arr.indexOf(idx), 1) : arr.push(idx);
            this.save();
        },
        isDone(rid, idx) { return this.doneSteps[rid]?.includes(idx); },
        addToPlan(day) {
            this.plan[day].push({ title: this.curR.title, servs: this.servings });
            this.showDayPicker = false; this.save(); alert('–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ ' + day);
        },
        removeFromPlan(day, idx) { this.plan[day].splice(idx, 1); this.save(); },
        clearPlan() { if(confirm('–û—á–∏—Å—Ç–∏—Ç—å –Ω–µ–¥–µ–ª—é?')) { Object.keys(this.plan).forEach(d => this.plan[d] = []); this.save(); } },
        save() {
            localStorage.setItem('sk_plan', JSON.stringify(this.plan));
            localStorage.setItem('sk_stock', JSON.stringify(this.stock));
            localStorage.setItem('sk_steps', JSON.stringify(this.doneSteps));
        },
        saveTpl() { if(!this.tplName) return; this.templates[this.tplName] = JSON.parse(JSON.stringify(this.plan)); localStorage.setItem('sk_tpls', JSON.stringify(this.templates)); this.tplName = ''; },
        loadTpl(n) { this.plan = JSON.parse(JSON.stringify(this.templates[n])); this.save(); },
        delTpl(n) { delete this.templates[n]; localStorage.setItem('sk_tpls', JSON.stringify(this.templates)); },
        exportTG() {
            let msg = "üõí –°–ü–ò–°–û–ö –ü–û–ö–£–ü–û–ö:\n";
            for (let d in this.shoppingList) {
                msg += `\nüì¶ ${d.toUpperCase()}:\n`;
                this.shoppingList[d].forEach(i => msg += `‚Ä¢ ${i.name}: ${i.amount} ${i.unit}\n`);
            }
            msg += "\nüìÖ –ú–ï–ù–Æ:\n";
            for (let day in this.plan) if(this.plan[day].length) msg += `${day}: ${this.plan[day].map(x=>x.title).join(', ')}\n`;
            window.location.href = `tg://msg?text=${encodeURIComponent(msg)}`;
        }
    },
    mounted() {
        window.startGlobalTimer = (m) => {
            this.timeLeft = m * 60;
            if(this.timerObj) clearInterval(this.timerObj);
            this.timerObj = setInterval(() => {
                this.timeLeft--;
                if(this.timeLeft <= 0) { clearInterval(this.timerObj); alert('–í—Ä–µ–º—è –≤—ã—à–ª–æ!'); }
            }, 1000);
        };
    }
}).mount('#app');

// Service Worker –¥–ª—è PWA
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js').catch(() => {});
}
</script>
</body>
</html>
