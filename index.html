<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ScandiKitchen Master Pro</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="recipes.js"></script>
    <style>
        :root {
            --bg-color: #f4f1ea;
            --accent-color: #556b2f;
            --secondary-color: #d4e0c0;
            --text-color: #2c3e50;
            --white: #ffffff;
            --radius: 20px;
            --shadow: 0 10px 30px rgba(0,0,0,0.05);
        }

        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0; padding: 0;
            -webkit-font-smoothing: antialiased;
        }

        /* UI Elements */
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .card {
            background: var(--white);
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: var(--shadow);
            transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .card:active { transform: scale(0.98); }

        .btn {
            background: var(--accent-color);
            color: white; border: none;
            padding: 14px 24px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex; align-items: center; gap: 8px;
            transition: 0.2s;
        }
        .btn:active { transform: scale(0.95); opacity: 0.9; }
        .btn-outline { background: #e0e0e0; color: var(--text-color); }

        /* Navigation */
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .logo { display: flex; align-items: center; gap: 10px; font-size: 24px; font-weight: bold; color: var(--accent-color); }

        /* Filter System */
        .search-box { width: 100%; margin-bottom: 20px; }
        .search-input {
            width: 100%; padding: 18px;
            border-radius: 15px; border: none;
            box-shadow: var(--shadow); font-size: 16px;
        }
        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 10px; margin-bottom: 20px;
        }
        .filter-chip {
            padding: 12px; background: var(--white);
            border-radius: 12px; text-align: center;
            cursor: pointer; font-size: 14px; box-shadow: var(--shadow);
            border: 2px solid transparent;
        }
        .filter-chip.active { border-color: var(--accent-color); font-weight: bold; }

        /* Catalog Grid */
        .recipe-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 25px;
        }

        /* Recipe Page */
        .recipe-content { display: grid; grid-template-columns: 1fr 1fr; gap: 40px; }
        @media (max-width: 768px) { .recipe-content { grid-template-columns: 1fr; } }
        
        .instruction-text { white-space: pre-line; line-height: 1.8; }
        .timer-tag {
            background: #e8f0e0; color: var(--accent-color);
            padding: 2px 8px; border-radius: 6px; font-weight: bold; cursor: pointer;
        }

        /* Day Grid */
        .week-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; }
        .day-box { background: var(--white); padding: 15px; border-radius: 15px; min-height: 100px; }
        .day-btn-large { min-width: 44px; min-height: 44px; padding: 10px; font-size: 18px; }

        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.4); display: flex; align-items: center; justify-content: center; z-index: 1000;
        }

        [v-cloak] { display: none; }
    </style>
</head>
<body>
    <div id="app" v-cloak>
        <div class="container">
            <header>
                <div class="logo" @click="view = 'catalog'">üåø ScandiKitchen</div>
                <div style="display: flex; gap: 10px;">
                    <button class="btn" @click="view = 'planner'">üìÖ –ü–õ–ê–ù</button>
                    <button class="btn btn-outline" @click="view = 'shopping'">üõí –ü–û–ö–£–ü–ö–ò</button>
                </div>
            </header>

            <main v-if="view === 'catalog'">
                <div class="search-box">
                    <input type="text" v-model="searchQuery" class="search-input" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∏–ª–∏ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—É...">
                </div>

                <div class="filter-grid">
                    <div v-for="cat in mainCategories" 
                         :key="cat" 
                         class="filter-chip"
                         :class="{ active: selectedMainCat === cat }"
                         @click="selectMainCategory(cat)">
                        {{ cat }}
                    </div>
                </div>

                <div v-if="availableSubCats.length" class="filter-grid" style="margin-top: -10px;">
                    <div v-for="sub in availableSubCats" 
                         :key="sub" 
                         class="filter-chip"
                         style="font-size: 12px; padding: 8px;"
                         :class="{ active: selectedSubCat === sub }"
                         @click="selectedSubCat = (selectedSubCat === sub ? '' : sub)">
                        # {{ sub }}
                    </div>
                </div>

                <div class="recipe-grid">
                    <div v-for="recipe in filteredRecipes" :key="recipe.id" class="card" @click="openRecipe(recipe)">
                        <div style="font-size: 50px; margin-bottom: 15px;">{{ recipe.emoji }}</div>
                        <h3 style="margin: 0 0 10px 0;">{{ recipe.title }}</h3>
                        <div style="font-size: 14px; opacity: 0.7;">
                            ‚è± {{ recipe.time }} –º–∏–Ω ‚Ä¢ üî• {{ recipe.calories }} –∫–∫–∞–ª
                        </div>
                    </div>
                </div>
            </main>

            <main v-if="view === 'recipe' && currentRecipe">
                <button class="btn btn-outline" @click="view = 'catalog'" style="margin-bottom: 20px;">‚Üê –ù–∞–∑–∞–¥</button>
                
                <div class="recipe-content">
                    <div>
                        <div class="card" style="height: 300px; display: flex; align-items: center; justify-content: center; font-size: 100px; margin-bottom: 20px;">
                            {{ currentRecipe.emoji }}
                        </div>
                        <button v-if="currentRecipe.videoUrl" class="btn" @click="openVideo" style="width: 100%; background: #0088cc; margin-bottom: 10px;">
                            üì∫ –°–ú–û–¢–†–ï–¢–¨ –í–ò–î–ï–û-–£–†–û–ö
                        </button>
                        <button class="btn" @click="showDayPicker = true" style="width: 100%;">
                            üìÖ –î–û–ë–ê–í–ò–¢–¨ –í –ü–õ–ê–ù
                        </button>
                    </div>

                    <div class="card">
                        <h3>üõí –ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã / –ï—Å—Ç—å –¥–æ–º–∞</h3>
                        <div v-for="(ing, idx) in currentRecipe.ingredients" :key="idx" 
                             style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #f0f0f0;">
                            <span>{{ ing.name }}</span>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <b>{{ ing.amount }} {{ ing.unit }}</b>
                                <input type="number" v-model.number="tempStock[ing.name]" placeholder="0" 
                                       style="width: 50px; padding: 5px; border-radius: 8px; border: 1px solid #ddd;">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-top: 30px;">
                    <h3>üë®‚Äçüç≥ –°–ø–æ—Å–æ–± –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è</h3>
                    <div class="instruction-text" v-html="renderInstructions(currentRecipe.instructions)"></div>
                </div>
            </main>

            <main v-if="view === 'planner'">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>–ü–ª–∞–Ω –Ω–∞ –Ω–µ–¥–µ–ª—é</h2>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-outline" @click="saveTemplate">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —à–∞–±–ª–æ–Ω</button>
                        <button class="btn" style="background: #c0392b;" @click="clearWeek">üóë –°–±—Ä–æ—Å</button>
                    </div>
                </div>

                <div class="week-grid">
                    <div v-for="day in weekDays" :key="day" class="day-box card">
                        <b style="color: var(--accent-color)">{{ day }}</b>
                        <div v-for="(meal, idx) in plan[day]" :key="idx" style="font-size: 13px; margin-top: 8px; display: flex; justify-content: space-between;">
                            <span>{{ meal.emoji }} {{ meal.title }}</span>
                            <span style="color: red; cursor: pointer;" @click="removeFromPlan(day, idx)">√ó</span>
                        </div>
                    </div>
                </div>

                <div v-if="Object.keys(templates).length" style="margin-top: 30px;">
                    <h4>–í–∞—à–∏ —à–∞–±–ª–æ–Ω—ã:</h4>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button v-for="(t, name) in templates" class="btn btn-outline" @click="loadTemplate(name)">{{ name }}</button>
                    </div>
                </div>
            </main>

            <main v-if="view === 'shopping'">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>–°–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫</h2>
                    <button class="btn" style="background: #24A1DE;" @click="exportToTelegram">‚úà –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ Telegram</button>
                </div>

                <div class="card">
                    <div v-for="(items, cat) in shoppingList" :key="cat">
                        <h4 style="color: var(--accent-color); border-bottom: 2px solid var(--secondary-color); padding-bottom: 5px;">{{ cat }}</h4>
                        <div v-for="item in items" :key="item.name" style="padding: 10px 0; display: flex; align-items: center; gap: 12px;">
                            <input type="checkbox" style="width: 20px; height: 20px;">
                            <span>{{ item.name }} ‚Äî <b>{{ item.amount }} {{ item.unit }}</b></span>
                        </div>
                    </div>
                    <div v-if="Object.keys(shoppingList).length === 0" style="text-align: center; padding: 40px; opacity: 0.5;">
                        –ü–ª–∞–Ω –ø—É—Å—Ç. –î–æ–±–∞–≤—å—Ç–µ —Ä–µ—Ü–µ–ø—Ç—ã –≤ –ø–ª–∞–Ω –Ω–∞ –Ω–µ–¥–µ–ª—é.
                    </div>
                </div>
            </main>
        </div>

        <div v-if="showDayPicker" class="modal-overlay" @click.self="showDayPicker = false">
            <div class="card" style="max-width: 400px; width: 90%;">
                <h3>–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–Ω—å:</h3>
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;">
                    <button v-for="day in weekDays" class="btn btn-outline day-btn-large" @click="addToPlan(day)">{{ day }}</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    view: 'catalog',
                    searchQuery: '',
                    selectedMainCat: '',
                    selectedSubCat: '',
                    currentRecipe: null,
                    showDayPicker: false,
                    tempStock: {}, // –í—Ä–µ–º–µ–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ "–µ—Å—Ç—å –¥–æ–º–∞" –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —Ä–µ—Ü–µ–ø—Ç–∞
                    plan: JSON.parse(localStorage.getItem('sk_plan_v2') || '{}'),
                    stock: JSON.parse(localStorage.getItem('sk_stock_v2') || '{}'),
                    templates: JSON.parse(localStorage.getItem('sk_templates_v2') || '{}'),
                    mainCategories: ['üçú –°—É–ø—ã', 'ü•ó –°–∞–ª–∞—Ç—ã', 'ü•© –û—Å–Ω–æ–≤–Ω—ã–µ (–º—è—Å–æ)', 'üêü –û—Å–Ω–æ–≤–Ω—ã–µ (—Ä—ã–±–∞)', 'üçö –ì–∞—Ä–Ω–∏—Ä—ã', 'ü•ß –í—ã–ø–µ—á–∫–∞', 'üç∞ –î–µ—Å–µ—Ä—Ç—ã', 'üçπ –ù–∞–ø–∏—Ç–∫–∏', 'ü•® –ó–∞–∫—É—Å–∫–∏', 'üßÇ –°–æ—É—Å—ã'],
                    weekDays: ['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'],
                    recipes: initialRecipes
                }
            },
            computed: {
                availableSubCats() {
                    if (!this.selectedMainCat) return [];
                    const subs = this.recipes
                        .filter(r => r.mainCategory === this.selectedMainCat)
                        .map(r => r.subCategory);
                    return [...new Set(subs)];
                },
                filteredRecipes() {
                    return this.recipes.filter(r => {
                        const matchesSearch = r.title.toLowerCase().includes(this.searchQuery.toLowerCase()) || 
                                              r.ingredients.some(i => i.name.toLowerCase().includes(this.searchQuery.toLowerCase()));
                        const matchesMain = !this.selectedMainCat || r.mainCategory === this.selectedMainCat;
                        const matchesSub = !this.selectedSubCat || r.subCategory === this.selectedSubCat;
                        return matchesSearch && matchesMain && matchesSub;
                    });
                },
                shoppingList() {
                    let needed = {};
                    
                    // 1. –ê–≥—Ä–µ–≥–∞—Ü–∏—è –≤—Å–µ—Ö –Ω—É–∂–¥ –∏–∑ –ø–ª–∞–Ω–∞
                    Object.values(this.plan).flat().forEach(recipe => {
                        recipe.ingredients.forEach(ing => {
                            if (!needed[ing.name]) {
                                needed[ing.name] = { amount: 0, unit: ing.unit, category: ing.category };
                            }
                            needed[ing.name].amount += ing.amount;
                        });
                    });

                    // 2. –í—ã—á–∏—Ç–∞–Ω–∏–µ –æ—Å—Ç–∞—Ç–∫–æ–≤ –∏ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞
                    let finalGroups = {};
                    for (let name in needed) {
                        const have = this.stock[name] || 0;
                        const toBuy = Math.max(0, needed[name].amount - have);
                        
                        if (toBuy > 0) {
                            const cat = needed[name].category || '–ü—Ä–æ—á–µ–µ';
                            if (!finalGroups[cat]) finalGroups[cat] = [];
                            finalGroups[cat].push({ name, amount: toBuy, unit: needed[name].unit });
                        }
                    }
                    return finalGroups;
                }
            },
            methods: {
                selectMainCategory(cat) {
                    this.selectedMainCat = this.selectedMainCat === cat ? '' : cat;
                    this.selectedSubCat = '';
                },
                openRecipe(recipe) {
                    this.currentRecipe = recipe;
                    this.tempStock = {}; // –°–±—Ä–æ—Å –≤–≤–æ–¥–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
                    this.view = 'recipe';
                    window.scrollTo(0,0);
                },
                renderInstructions(text) {
                    return text.replace(/(\d+)\s*(–º–∏–Ω—É—Ç|–º–∏–Ω)/gi, '<span class="timer-tag">$1 $2</span>');
                },
                addToPlan(day) {
                    if (!this.plan[day]) this.plan[day] = [];
                    this.plan[day].push(JSON.parse(JSON.stringify(this.currentRecipe)));
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Å—Ç–∞—Ç–∫–∏ –≤ –≥–ª–æ–±–∞–ª—å–Ω—ã–π —Å—Ç–æ–∫
                    for (let item in this.tempStock) {
                        this.stock[item] = (this.stock[item] || 0) + this.tempStock[item];
                    }
                    
                    this.saveData();
                    this.showDayPicker = false;
                    alert(`–î–æ–±–∞–≤–ª–µ–Ω–æ –Ω–∞ ${day}`);
                },
                removeFromPlan(day, idx) {
                    this.plan[day].splice(idx, 1);
                    this.saveData();
                },
                clearWeek() {
                    if(confirm("–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –ø–ª–∞–Ω—ã –Ω–∞ –Ω–µ–¥–µ–ª—é?")) {
                        this.plan = {};
                        this.stock = {};
                        this.saveData();
                    }
                },
                saveTemplate() {
                    const name = prompt("–ù–∞–∑–æ–≤–∏—Ç–µ —à–∞–±–ª–æ–Ω (–Ω–∞–ø—Ä. '–ü—Ä–∞–∑–¥–Ω–∏—á–Ω—ã–π'):");
                    if (name) {
                        this.templates[name] = { plan: JSON.parse(JSON.stringify(this.plan)), stock: JSON.parse(JSON.stringify(this.stock)) };
                        this.saveData();
                    }
                },
                loadTemplate(name) {
                    const t = this.templates[name];
                    this.plan = JSON.parse(JSON.stringify(t.plan));
                    this.stock = JSON.parse(JSON.stringify(t.stock));
                    this.saveData();
                },
                saveData() {
                    localStorage.setItem('sk_plan_v2', JSON.stringify(this.plan));
                    localStorage.setItem('sk_stock_v2', JSON.stringify(this.stock));
                    localStorage.setItem('sk_templates_v2', JSON.stringify(this.templates));
                },
                exportToTelegram() {
                    let text = "üõí –°–ü–ò–°–û–ö –ü–û–ö–£–ü–û–ö:\n";
                    for (let cat in this.shoppingList) {
                        text += `\nüîπ ${cat.toUpperCase()}:\n`;
                        this.shoppingList[cat].forEach(i => text += `‚Ä¢ ${i.name}: ${i.amount} ${i.unit}\n`);
                    }
                    text += "\nüìÖ –ü–õ–ê–ù –ú–ï–ù–Æ:\n";
                    this.weekDays.forEach(day => {
                        if (this.plan[day]?.length) {
                            text += `${day}: ${this.plan[day].map(m => m.title).join(', ')}\n`;
                        }
                    });
                    window.location.href = `tg://msg?text=${encodeURIComponent(text)}`;
                }
            }
        }).mount('#app');
    </script>
</body>
</html>
