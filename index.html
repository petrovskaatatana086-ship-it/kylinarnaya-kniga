<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ScandiKitchen v2.7</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="recipes.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #f4f1ea;
            --accent-color: #556b2f;
            --secondary-color: #d4e0c0;
            --text-color: #2c3e50;
            --white: #ffffff;
            --shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg-color); 
            color: var(--text-color);
            margin: 0; padding: 0;
            line-height: 1.6;
        }

        /* Layout */
        .container { max-width: 600px; margin: 0 auto; padding: 20px; padding-bottom: 100px; }
        
        /* Typography */
        h1, h2 { color: var(--accent-color); font-weight: 600; }
        
        /* Components */
        .card {
            background: var(--white);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: var(--shadow);
            transition: transform 0.2s;
        }

        .btn {
            background: var(--accent-color);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--accent-color);
            color: var(--accent-color);
        }

        /* Navigation */
        .nav-bar {
            position: fixed;
            bottom: 0; left: 0; right: 0;
            background: var(--white);
            display: flex;
            justify-content: space-around;
            padding: 15px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
            z-index: 100;
        }
        .nav-item { cursor: pointer; font-size: 24px; opacity: 0.5; }
        .nav-item.active { opacity: 1; color: var(--accent-color); }

        /* Search */
        .search-input {
            width: 100%;
            padding: 15px;
            border-radius: 12px;
            border: 1px solid var(--secondary-color);
            margin-bottom: 20px;
            font-size: 16px;
        }

        /* Recipe Page */
        .recipe-header { position: relative; }
        .recipe-img { width: 100%; height: 200px; object-fit: cover; border-radius: 16px; background: #eee; }
        
        .timer-btn {
            background: var(--secondary-color);
            padding: 4px 8px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            display: inline-block;
        }

        .instruction-step {
            cursor: pointer;
            margin-bottom: 10px;
            transition: 0.3s;
        }
        .instruction-step.done {
            text-decoration: line-through;
            opacity: 0.4;
        }

        /* Floating Timer */
        .floating-timer {
            position: fixed;
            top: 20px; right: 20px;
            background: var(--accent-color);
            color: white;
            padding: 15px 25px;
            border-radius: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 15px;
            z-index: 1000;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }
        .modal-content {
            background: var(--white);
            padding: 24px;
            border-radius: 20px;
            width: 100%;
            max-width: 400px;
        }
        .day-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 20px;
        }
        .day-btn {
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid var(--secondary-color);
            border-radius: 10px;
            cursor: pointer;
        }

        /* Shopping List */
        .category-title {
            background: var(--secondary-color);
            padding: 5px 12px;
            border-radius: 8px;
            font-size: 0.9em;
            margin-top: 20px;
        }

        [v-cloak] { display: none; }
    </style>
</head>
<body>
    <div id="app" v-cloak>
        <div v-if="activeTimer" class="floating-timer">
            ‚è±Ô∏è {{ formatTime(timeLeft) }}
            <span @click="stopTimer" style="cursor:pointer">‚úï</span>
        </div>

        <div class="container">
            <div v-if="view === 'catalog'">
                <h1>ScandiKitchen</h1>
                <input type="text" v-model="searchQuery" placeholder="–ü–æ–∏—Å–∫ —Ä–µ—Ü–µ–ø—Ç–æ–≤..." class="search-input">
                
                <div v-for="recipe in filteredRecipes" :key="recipe.id" class="card" @click="openRecipe(recipe)">
                    <div style="font-size: 40px">{{ recipe.emoji }}</div>
                    <h3>{{ recipe.title }}</h3>
                    <div style="font-size: 0.9em; color: #666;">
                        ‚è± {{ recipe.time }} –º–∏–Ω | üî• {{ recipe.calories }} –∫–∫–∞–ª
                    </div>
                </div>
            </div>

            <div v-if="view === 'recipe'">
                <button @click="view = 'catalog'" class="btn btn-outline" style="margin-bottom: 15px;">‚Üê –ù–∞–∑–∞–¥</button>
                
                <div class="recipe-header">
                    <img :src="currentRecipe.image || 'https://via.placeholder.com/600x400?text=ScandiKitchen'" class="recipe-img">
                    <input type="file" @change="handleFileUpload" style="margin-top: 10px; font-size: 12px;">
                </div>

                <h2>{{ currentRecipe.emoji }} {{ currentRecipe.title }}</h2>
                
                <div class="card">
                    <h4>–ü–æ—Ä—Ü–∏–∏: 
                        <button @click="changeServings(-1)" class="btn-outline" style="padding: 2px 10px">-</button> 
                        {{ servings }} 
                        <button @click="changeServings(1)" class="btn-outline" style="padding: 2px 10px">+</button>
                    </h4>
                    <ul>
                        <li v-for="ing in currentRecipe.ingredients" :key="ing.name" style="margin-bottom: 8px;">
                            {{ ing.name }}: <b>{{ calculateAmount(ing) }} {{ ing.unit }}</b>
                            <div style="font-size: 0.8em; color: gray;">
                                –ï—Å—Ç—å –≤ –Ω–∞–ª–∏—á–∏–∏ ({{ ing.unit }}): 
                                <input type="number" v-model.number="stock[ing.name]" style="width: 60px; border: 1px solid #ccc; border-radius: 4px;">
                            </div>
                        </li>
                    </ul>
                </div>

                <div class="card">
                    <h4>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è</h4>
                    <div v-for="(line, idx) in formattedInstructions" :key="idx" 
                         class="instruction-step" 
                         :class="{ done: completedSteps.includes(idx) }"
                         @click="toggleStep(idx)"
                         v-html="line">
                    </div>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button @click="showDayPicker = true" class="btn">–í –ø–ª–∞–Ω –Ω–µ–¥–µ–ª–∏</button>
                    <a v-if="currentRecipe.videoUrl" :href="currentRecipe.videoUrl" target="_blank" class="btn btn-outline">–í–∏–¥–µ–æ-—É—Ä–æ–∫</a>
                </div>
            </div>

            <div v-if="view === 'planner'">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h1>–ú–æ–π –ø–ª–∞–Ω</h1>
                    <button @click="clearWeek" class="btn btn-outline" style="font-size: 12px;">–û—á–∏—Å—Ç–∏—Ç—å</button>
                </div>

                <div v-for="day in weekDays" :key="day" class="card">
                    <h4 style="margin-top: 0; color: var(--accent-color);">{{ day }}</h4>
                    <div v-for="(meal, idx) in plan[day]" :key="idx" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                        <span>{{ meal.emoji }} {{ meal.title }}</span>
                        <span @click="removeFromPlan(day, idx)" style="cursor: pointer; color: red;">√ó</span>
                    </div>
                    <div v-if="!plan[day] || plan[day].length === 0" style="color: #ccc; font-size: 0.8em;">–ù–µ—Ç –ø–ª–∞–Ω–æ–≤</div>
                </div>

                <div style="margin-top: 20px;">
                    <h4>–®–∞–±–ª–æ–Ω—ã</h4>
                    <button @click="saveTemplate" class="btn btn-outline">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–µ–∫—É—â–∏–π</button>
                    <div class="day-grid">
                        <div v-for="(t, name) in templates" :key="name" @click="loadTemplate(name)" class="day-btn" style="font-size: 10px; text-align: center;">
                            {{ name }}
                        </div>
                    </div>
                </div>
            </div>

            <div v-if="view === 'shopping'">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h1>–ü–æ–∫—É–ø–∫–∏</h1>
                    <button @click="exportToTelegram" class="btn">–í Telegram</button>
                </div>

                <div v-for="(items, cat) in groupedShoppingList" :key="cat">
                    <div class="category-title">{{ cat }}</div>
                    <div v-for="item in items" :key="item.name" style="padding: 10px 0; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" v-model="boughtItems[item.name]">
                        <span :style="{ textDecoration: boughtItems[item.name] ? 'line-through' : 'none' }">
                            {{ item.name }} ‚Äî <b>{{ item.amount }} {{ item.unit }}</b>
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="showDayPicker" class="modal-overlay" @click.self="showDayPicker = false">
            <div class="modal-content">
                <h3>–ö—É–¥–∞ –¥–æ–±–∞–≤–∏–º?</h3>
                <div class="day-grid">
                    <div v-for="day in weekDays" :key="day" class="day-btn" @click="addToPlan(day)">
                        {{ day }}
                    </div>
                </div>
            </div>
        </div>

        <nav class="nav-bar">
            <div class="nav-item" :class="{ active: view === 'catalog' }" @click="view = 'catalog'">üìñ</div>
            <div class="nav-item" :class="{ active: view === 'planner' }" @click="view = 'planner'">üìÖ</div>
            <div class="nav-item" :class="{ active: view === 'shopping' }" @click="view = 'shopping'">üõí</div>
        </nav>
    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    view: 'catalog',
                    recipes: initialRecipes,
                    searchQuery: '',
                    currentRecipe: null,
                    servings: 2,
                    completedSteps: [],
                    stock: JSON.parse(localStorage.getItem('sk_stock') || '{}'),
                    plan: JSON.parse(localStorage.getItem('sk_plan') || '{}'),
                    templates: JSON.parse(localStorage.getItem('sk_templates') || '{}'),
                    boughtItems: {},
                    showDayPicker: false,
                    weekDays: ['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'],
                    activeTimer: null,
                    timeLeft: 0,
                    timerInterval: null
                }
            },
            computed: {
                filteredRecipes() {
                    return this.recipes.filter(r => r.title.toLowerCase().includes(this.searchQuery.toLowerCase()));
                },
                formattedInstructions() {
                    if (!this.currentRecipe) return [];
                    const text = this.currentRecipe.instructions;
                    // Regex to find minutes like "35 –º–∏–Ω—É—Ç"
                    return text.split('\n').map(line => {
                        return line.replace(/(\d+)\s*(–º–∏–Ω—É—Ç|–º–∏–Ω)/gi, (match, p1) => {
                            return `<span class="timer-btn" onclick="window.startTimer(${p1})">${match}</span>`;
                        });
                    });
                },
                groupedShoppingList() {
                    let list = [];
                    // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –∏–∑ –ø–ª–∞–Ω–∞
                    Object.values(this.plan).flat().forEach(recipe => {
                        recipe.ingredients.forEach(ing => {
                            const needed = (ing.amount / 2) * 2; // –ë–∞–∑–æ–≤—ã–π —Ä–∞—Å—á–µ—Ç
                            const inStock = this.stock[ing.name] || 0;
                            const final = needed - inStock;
                            
                            if (final > 0) {
                                list.push({ ...ing, amount: final });
                            }
                        });
                    });

                    // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
                    const grouped = {};
                    list.forEach(item => {
                        const cat = item.category || '–ü—Ä–æ—á–µ–µ';
                        if (!grouped[cat]) grouped[cat] = [];
                        
                        const existing = grouped[cat].find(i => i.name === item.name);
                        if (existing) {
                            existing.amount += item.amount;
                        } else {
                            grouped[cat].push({...item});
                        }
                    });
                    return grouped;
                }
            },
            watch: {
                plan: { deep: true, handler(v) { localStorage.setItem('sk_plan', JSON.stringify(v)); }},
                stock: { deep: true, handler(v) { localStorage.setItem('sk_stock', JSON.stringify(v)); }},
                templates: { deep: true, handler(v) { localStorage.setItem('sk_templates', JSON.stringify(v)); }}
            },
            methods: {
                openRecipe(recipe) {
                    this.currentRecipe = recipe;
                    this.view = 'recipe';
                    this.servings = 2;
                    this.completedSteps = [];
                    window.scrollTo(0,0);
                },
                calculateAmount(ing) {
                    return Math.round((ing.amount / 2) * this.servings);
                },
                changeServings(val) {
                    this.servings = Math.max(1, this.servings + val);
                },
                toggleStep(idx) {
                    if (this.completedSteps.includes(idx)) {
                        this.completedSteps = this.completedSteps.filter(i => i !== idx);
                    } else {
                        this.completedSteps.push(idx);
                    }
                },
                addToPlan(day) {
                    if (!this.plan[day]) this.plan[day] = [];
                    this.plan[day].push({ ...this.currentRecipe });
                    this.showDayPicker = false;
                    alert('–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ ' + day);
                },
                removeFromPlan(day, idx) {
                    this.plan[day].splice(idx, 1);
                },
                clearWeek() {
                    if (confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤–µ—Å—å –ø–ª–∞–Ω?')) this.plan = {};
                },
                saveTemplate() {
                    const name = prompt('–ù–∞–∑–æ–≤–∏—Ç–µ —à–∞–±–ª–æ–Ω (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ü—Ä–∞–∑–¥–Ω–∏—á–Ω—ã–π)');
                    if (name) this.templates[name] = JSON.parse(JSON.stringify(this.plan));
                },
                loadTemplate(name) {
                    this.plan = JSON.parse(JSON.stringify(this.templates[name]));
                },
                handleFileUpload(e) {
                    const file = e.target.files[0];
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        this.currentRecipe.image = event.target.result;
                    };
                    reader.readAsDataURL(file);
                },
                formatTime(seconds) {
                    const m = Math.floor(seconds / 60);
                    const s = seconds % 60;
                    return `${m}:${s < 10 ? '0' : ''}${s}`;
                },
                startTimer(mins) {
                    this.stopTimer();
                    this.activeTimer = true;
                    this.timeLeft = mins * 60;
                    this.timerInterval = setInterval(() => {
                        this.timeLeft--;
                        if (this.timeLeft <= 0) {
                            this.stopTimer();
                            new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg').play();
                            alert('–¢–∞–π–º–µ—Ä –∑–∞–≤–µ—Ä—à–µ–Ω!');
                        }
                    }, 1000);
                },
                stopTimer() {
                    clearInterval(this.timerInterval);
                    this.activeTimer = false;
                },
                exportToTelegram() {
                    let text = "üõí –ú–û–ô –°–ü–ò–°–û–ö –ü–û–ö–£–ü–û–ö:\n\n";
                    for (const [cat, items] of Object.entries(this.groupedShoppingList)) {
                        text += `--- ${cat.toUpperCase()} ---\n`;
                        items.forEach(i => {
                            text += `${this.boughtItems[i.name] ? '‚úÖ' : '‚òê'} ${i.name}: ${i.amount} ${i.unit}\n`;
                        });
                        text += "\n";
                    }
                    text += "üìÖ –ü–õ–ê–ù –ú–ï–ù–Æ:\n";
                    this.weekDays.forEach(day => {
                        if (this.plan[day]?.length) {
                            text += `${day}: ${this.plan[day].map(r => r.title).join(', ')}\n`;
                        }
                    });
                    
                    window.location.href = `tg://msg?text=${encodeURIComponent(text)}`;
                }
            },
            mounted() {
                window.startTimer = (m) => this.startTimer(m);
            }
        }).mount('#app');
    </script>
</body>
</html>
