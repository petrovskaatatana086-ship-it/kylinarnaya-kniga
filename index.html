<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ScandiKitchen Master v3.1</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="recipes.js"></script>
    <style>
        :root {
            --bg: #f4f1ea; --olive: #556b2f; --light: #d4e0c0; --white: #ffffff; --text: #2c3e50;
        }
        body { font-family: 'Helvetica Neue', Arial, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 40px; }
        .container { max-width: 900px; margin: 0 auto; padding: 20px; }
        
        /* –ù–∞–≤–∏–≥–∞—Ü–∏—è —Å–≤–µ—Ä—Ö—É */
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .logo { font-size: 24px; font-weight: bold; color: var(--olive); cursor: pointer; }
        .nav-buttons { display: flex; gap: 10px; }

        .card { background: var(--white); border-radius: 20px; padding: 20px; box-shadow: 0 8px 24px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .btn { background: var(--olive); color: white; border: none; padding: 12px 20px; border-radius: 12px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn:active { transform: scale(0.98); }
        .btn-outline { background: #e0e0e0; color: var(--text); }

        /* –°–µ—Ç–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π */
        .filter-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; margin-bottom: 25px; }
        .tab { padding: 12px; background: var(--white); border-radius: 15px; cursor: pointer; text-align: center; font-size: 14px; border: 2px solid transparent; }
        .tab.active { border-color: var(--olive); font-weight: bold; }

        .search-input { width: 100%; padding: 18px; border-radius: 15px; border: none; box-shadow: 0 8px 24px rgba(0,0,0,0.05); font-size: 16px; margin-bottom: 20px; box-sizing: border-box; }

        /* –§–æ—Ç–æ —Ç–æ–ª—å–∫–æ –≤ —Ä–µ—Ü–µ–ø—Ç–µ */
        .recipe-photo { width: 100%; height: 350px; border-radius: 20px; overflow: hidden; margin-bottom: 20px; background: #ddd; display: flex; align-items: center; justify-content: center; }
        .recipe-photo img { width: 100%; height: 100%; object-fit: cover; }

        .instr-step { white-space: pre-line; padding: 10px; border-radius: 10px; cursor: pointer; }
        .instr-step.done { opacity: 0.4; text-decoration: line-through; }
        .timer-tag { color: var(--olive); font-weight: bold; text-decoration: underline; cursor: pointer; }

        .timer-widget { position: fixed; bottom: 20px; right: 20px; background: var(--olive); color: white; padding: 15px 25px; border-radius: 30px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); z-index: 1000; display: flex; align-items: center; gap: 15px; font-size: 18px; }
        
        [v-cloak] { display: none; }
    </style>
</head>
<body>
    <div id="app" v-cloak>
        <div v-if="timeLeft > 0" class="timer-widget">
            <span>‚è± {{ Math.floor(timeLeft / 60) }}:{{ (timeLeft % 60).toString().padStart(2, '0') }}</span>
            <button @click="stopTimer" style="background:none; border:none; color:white; cursor:pointer; font-size:20px;">‚úï</button>
        </div>

        <div class="container">
            <header>
                <div class="logo" @click="view = 'catalog'">üåø ScandiKitchen</div>
                <div class="nav-buttons">
                    <button class="btn" @click="view = 'planner'">üìÖ –ü–õ–ê–ù</button>
                    <button class="btn btn-outline" @click="view = 'shopping'">üõí –ü–û–ö–£–ü–ö–ò</button>
                </div>
            </header>

            <main v-if="view === 'catalog'">
                <input type="text" v-model="search" class="search-input" placeholder="–ü–æ–∏—Å–∫ (–±–ª—é–¥–æ –∏–ª–∏ –ø—Ä–æ–¥—É–∫—Ç)...">
                <div class="filter-grid">
                    <div class="tab" :class="{active: filterCat === ''}" @click="filterCat = ''">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</div>
                    <div v-for="cat in mainCategories" :key="cat" class="tab" :class="{active: filterCat === cat}" @click="filterCat = cat">{{cat}}</div>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px;">
                    <div v-for="recipe in filteredRecipes" :key="recipe.id" class="card" @click="openRecipe(recipe)" style="cursor:pointer">
                        <div style="font-size: 40px; margin-bottom: 10px;">{{recipe.emoji}}</div>
                        <h3 style="margin:0;">{{recipe.title}}</h3>
                        <p style="opacity:0.6; font-size:14px; margin-top:5px;">{{recipe.time}} –º–∏–Ω ‚Ä¢ {{recipe.calories}} –∫–∫–∞–ª</p>
                    </div>
                </div>
            </main>

            <main v-if="view === 'recipe'">
                <button @click="view = 'catalog'" class="btn btn-outline" style="margin-bottom:20px;">‚Üê –ù–∞–∑–∞–¥</button>
                
                <div class="recipe-photo" @click="$refs.fileInput.click()">
                    <img v-if="userPhotos[currentRecipe.id]" :src="userPhotos[currentRecipe.id]">
                    <span v-else>üì∑ –î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ —Ä–µ—Ü–µ–ø—Ç–∞</span>
                    <input type="file" ref="fileInput" @change="uploadPhoto" style="display:none">
                </div>

                <h1>{{currentRecipe.emoji}} {{currentRecipe.title}}</h1>

                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                        <h3 style="margin:0;">–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã</h3>
                        <div style="display:flex; gap:10px; align-items:center;">
                            <span>–ü–æ—Ä—Ü–∏–∏: {{servings}}</span>
                            <button @click="servings > 1 ? servings-- : null" class="btn btn-outline" style="padding:5px 12px;">-</button>
                            <button @click="servings++" class="btn btn-outline" style="padding:5px 12px;">+</button>
                        </div>
                    </div>
                    
                    <div v-for="(ing, idx) in currentRecipe.ingredients" :key="idx" style="display:flex; justify-content:space-between; align-items:center; padding:10px 0; border-bottom:1px solid #eee;">
                        <span :style="{textDecoration: stockCheck[ing.name] ? 'line-through' : 'none', opacity: stockCheck[ing.name] ? 0.5 : 1}">
                            {{ing.name}}: <b>{{ (ing.amount / 2 * servings).toFixed(1) }} {{ing.unit}}</b>
                        </span>
                        <div style="display:flex; gap:10px; align-items:center;">
                            <input type="number" v-model.number="stock[ing.name]" placeholder="0" style="width:60px; padding:5px; border-radius:8px; border:1px solid #ddd;">
                            <input type="checkbox" v-model="stockCheck[ing.name]">
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3>–°–ø–æ—Å–æ–± –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è (–ø–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç)</h3>
                    <div v-for="(line, idx) in formattedSteps" :key="idx" 
                         class="instr-step" :class="{done: doneSteps.includes(idx)}" 
                         @click="toggleStep(idx)" v-html="line"></div>
                </div>

                <div style="display:flex; gap:10px;">
                    <button class="btn" style="flex:1;" @click="showDayPicker = true">üìÖ –î–û–ë–ê–í–ò–¢–¨ –í –ü–õ–ê–ù</button>
                    <a v-if="currentRecipe.videoUrl" :href="currentRecipe.videoUrl" target="_blank" class="btn" style="background:#24A1DE; flex:1; text-align:center; display:block;">üì∫ –°–ú–û–¢–†–ï–¢–¨ –í–ò–î–ï–û</a>
                </div>
            </main>

            <main v-if="view === 'planner'">
                <h1>–ü–ª–∞–Ω –ø–∏—Ç–∞–Ω–∏—è –Ω–∞ –Ω–µ–¥–µ–ª—é</h1>
                <div v-for="day in weekDays" :key="day" class="card">
                    <h3 style="color:var(--olive); margin-top:0;">{{day}}</h3>
                    <div v-for="(meal, mIdx) in planByDay[day]" :key="mIdx" style="display:flex; justify-content:space-between; margin-bottom:8px;">
                        <span>{{meal.emoji}} {{meal.title}} ({{meal.servings}} –ø–æ—Ä—Ü.)</span>
                        <button @click="removeFromPlan(meal.id)" style="color:red; background:none; border:none; cursor:pointer;">√ó</button>
                    </div>
                    <div v-if="!planByDay[day].length" style="opacity:0.3; font-size:14px;">–ù–∏—á–µ–≥–æ –Ω–µ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ</div>
                </div>
            </main>

            <main v-if="view === 'shopping'">
                <h1>–ò—Ç–æ–≥–æ –∫ –ø–æ–∫—É–ø–∫–µ</h1>
                <div class="card">
                    <div v-for="(items, cat) in aggregatedList" :key="cat">
                        <h4 style="color:var(--olive); border-bottom:2px solid var(--light); padding-bottom:5px;">{{cat}}</h4>
                        <div v-for="item in items" :key="item.name" style="padding:8px 0; display:flex; justify-content:space-between;">
                            <span>{{item.name}}</span>
                            <b>{{item.buy}} {{item.unit}}</b>
                        </div>
                    </div>
                    <div v-if="Object.keys(aggregatedList).length === 0" style="text-align:center; padding:40px; opacity:0.5;">–í–∞—à —Å–ø–∏—Å–æ–∫ –ø—É—Å—Ç</div>
                </div>
                <button @click="exportToTelegram" class="btn" style="width:100%; background:#24A1DE; font-size:18px;">‚úà –û–¢–ü–†–ê–í–ò–¢–¨ –í TELEGRAM</button>
            </main>

            <div v-if="showDayPicker" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); display:flex; align-items:center; justify-content:center; z-index:2000;">
                <div class="card" style="width:300px;">
                    <h3>–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–Ω—å:</h3>
                    <div v-for="day in weekDays" :key="day" @click="saveToPlan(day)" style="padding:10px; cursor:pointer; border-bottom:1px solid #eee;">{{day}}</div>
                    <button class="btn btn-outline" @click="showDayPicker = false" style="width:100%; margin-top:15px;">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue;
        createApp({
            data() {
                return {
                    view: 'catalog', search: '', filterCat: '', currentRecipe: null, servings: 2, timeLeft: 0, timerInt: null,
                    doneSteps: [], showDayPicker: false,
                    mainCategories: ['üçú –°—É–ø—ã', 'ü•ó –°–∞–ª–∞—Ç—ã', 'ü•© –û—Å–Ω–æ–≤–Ω—ã–µ (–º—è—Å–æ, –ø—Ç–∏—Ü–∞)', 'üêü –û—Å–Ω–æ–≤–Ω—ã–µ (—Ä—ã–±–∞, –º–æ—Ä–µ–ø—Ä–æ–¥—É–∫—Ç—ã)', 'üçö –ì–∞—Ä–Ω–∏—Ä—ã', 'ü•ß –í—ã–ø–µ—á–∫–∞', 'üç∞ –î–µ—Å–µ—Ä—Ç—ã', 'üçπ –ù–∞–ø–∏—Ç–∫–∏'],
                    weekDays: ['–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫', '–í—Ç–æ—Ä–Ω–∏–∫', '–°—Ä–µ–¥–∞', '–ß–µ—Ç–≤–µ—Ä–≥', '–ü—è—Ç–Ω–∏—Ü–∞', '–°—É–±–±–æ—Ç–∞', '–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ'],
                    plan: JSON.parse(localStorage.getItem('sk_plan_v3') || '[]'),
                    stock: JSON.parse(localStorage.getItem('sk_stock_v3') || '{}'),
                    stockCheck: JSON.parse(localStorage.getItem('sk_checks_v3') || '{}'),
                    userPhotos: JSON.parse(localStorage.getItem('sk_photos_v3') || '{}')
                }
            },
            computed: {
                filteredRecipes() {
                    return initialRecipes.filter(r => {
                        const mS = r.title.toLowerCase().includes(this.search.toLowerCase()) || r.ingredients.some(i => i.name.toLowerCase().includes(this.search.toLowerCase()));
                        const mC = !this.filterCat || r.mainCategory === this.filterCat;
                        return mS && mC;
                    });
                },
                formattedSteps() {
                    if(!this.currentRecipe) return [];
                    return this.currentRecipe.instructions.split('\n').map(l => {
                        return l.replace(/(\d+)\s*(–º–∏–Ω—É—Ç|–º–∏–Ω)/gi, (m, p1) => `<span class="timer-tag" onclick="window.app.startTimer(${p1})">${m}</span>`);
                    });
                },
                planByDay() {
                    let map = {}; this.weekDays.forEach(d => map[d] = []);
                    this.plan.forEach(p => { if(map[p.day]) map[p.day].push(p); });
                    return map;
                },
                aggregatedList() {
                    let total = {};
                    this.plan.forEach(p => {
                        p.ingredients.forEach(ing => {
                            if(!total[ing.name]) total[ing.name] = { ...ing, amount: 0 };
                            total[ing.name].amount += (ing.amount / 2 * p.servings);
                        });
                    });
                    let grouped = {};
                    for(let n in total) {
                        const has = this.stock[n] || 0;
                        const buy = total[n].amount - has;
                        if(buy > 0 && !this.stockCheck[n]) {
                            const c = total[n].category || '–ü—Ä–æ—á–µ–µ';
                            if(!grouped[c]) grouped[grouped[c] = []];
                            grouped[c].push({ name: n, buy: buy.toFixed(1), unit: total[n].unit });
                        }
                    }
                    return grouped;
                }
            },
            methods: {
                openRecipe(r) { this.currentRecipe = r; this.view = 'recipe'; this.servings = 2; this.doneSteps = []; window.scrollTo(0,0); },
                toggleStep(i) { this.doneSteps.includes(i) ? this.doneSteps = this.doneSteps.filter(x => x !== i) : this.doneSteps.push(i); },
                startTimer(m) {
                    this.timeLeft = m * 60;
                    if(this.timerInt) clearInterval(this.timerInt);
                    this.timerInt = setInterval(() => {
                        if(this.timeLeft > 0) this.timeLeft--;
                        else { clearInterval(this.timerInt); alert("–í—Ä–µ–º—è –≤—ã—à–ª–æ!"); }
                    }, 1000);
                },
                stopTimer() { this.timeLeft = 0; clearInterval(this.timerInt); },
                uploadPhoto(e) {
                    const reader = new FileReader();
                    reader.onload = (f) => { this.userPhotos[this.currentRecipe.id] = f.target.result; this.save(); };
                    reader.readAsDataURL(e.target.files[0]);
                },
                saveToPlan(day) {
                    this.plan.push({ ...JSON.parse(JSON.stringify(this.currentRecipe)), id: Date.now(), day: day, servings: this.servings });
                    this.save(); this.showDayPicker = false; alert("–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ " + day);
                },
                removeFromPlan(id) { this.plan = this.plan.filter(p => p.id !== id); this.save(); },
                exportToTelegram() {
                    let txt = "üìã –ü–õ–ê–ù –ü–ò–¢–ê–ù–ò–Ø:\n";
                    this.weekDays.forEach(d => {
                        if(this.planByDay[d].length) txt += `\nüìç ${d.toUpperCase()}:\n` + this.planByDay[d].map(m => ` - ${m.title}`).join('\n') + '\n';
                    });
                    txt += "\nüõí –°–ü–ò–°–û–ö –ü–û–ö–£–ü–û–ö:\n";
                    for(let c in this.aggregatedList) {
                        txt += `\nüîπ ${c.toUpperCase()}:\n` + this.aggregatedList[c].map(i => ` ‚Ä¢ ${i.name}: ${i.buy} ${i.unit}`).join('\n') + '\n';
                    }
                    window.location.href = `tg://msg?text=${encodeURIComponent(txt)}`;
                },
                save() {
                    localStorage.setItem('sk_plan_v3', JSON.stringify(this.plan));
                    localStorage.setItem('sk_stock_v3', JSON.stringify(this.stock));
                    localStorage.setItem('sk_checks_v3', JSON.stringify(this.stockCheck));
                    localStorage.setItem('sk_photos_v3', JSON.stringify(this.userPhotos));
                }
            },
            mounted() { window.app = this; }
        }).mount('#app');
    </script>
</body>
</html>
